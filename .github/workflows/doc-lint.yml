# NizamIQ Documentation Linter
# This workflow enforces the Unified Documentation Standard (UDS).
# It is designed to be called as a reusable workflow from the Golden Pipeline.

name: Documentation Linter

on:
  workflow_call:

jobs:
  doc-lint:
    name: UDS Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for git diff

      - name: Find changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            docs/**/*.md

      - name: Setup Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install validation dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: pip install PyYAML jsonschema

      - name: Download UDS Schema
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          curl -s -L -o /tmp/frontmatter.schema.json \
          https://raw.githubusercontent.com/nizamiq/documentation-standard/main/schema/frontmatter.schema.json

      - name: Validate Frontmatter
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          python3 -c "
import os, sys, yaml, json
from jsonschema import validate, ValidationError

SCHEMA_PATH = '/tmp/frontmatter.schema.json'
CHANGED_FILES = os.environ.get('CHANGED_FILES', '').split()

with open(SCHEMA_PATH) as f:
    schema = json.load(f)

errors = []
for fpath in CHANGED_FILES:
    if not os.path.exists(fpath):
        continue
    try:
        with open(fpath) as f:
            content = f.read()
        if not content.startswith('---'):
            errors.append(f'::error file={fpath}::File does not start with YAML frontmatter.')
            continue
        
        end = content.find('---', 3)
        if end == -1:
            errors.append(f'::error file={fpath}::Frontmatter block is not properly closed with ---.')
            continue

        frontmatter = yaml.safe_load(content[3:end])
        validate(instance=frontmatter, schema=schema)
        print(f'::notice file={fpath}::Frontmatter validated successfully.')

    except yaml.YAMLError as e:
        errors.append(f'::error file={fpath}::Invalid YAML: {e}')
    except ValidationError as e:
        errors.append(f'::error file={fpath}::Schema validation failed: {e.message} on field `{e.path[0] if e.path else 'root'}`')
    except Exception as e:
        errors.append(f'::error file={fpath}::An unexpected error occurred: {e}')

if errors:
    for error in errors:
        print(error)
    sys.exit(1)
          "          
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
